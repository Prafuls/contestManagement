<h2><a class="anchor" id="visualizations"></a>Visualizations</h2>

<div class="panel-group" id="accordion">
	#foreach($subject in $subjects)
   		#set($title = $subject.getName().concat(" Comparison"))
        	
		<div class="panel panel-default">
			<div class="panel-heading">
				<a class="panel-title" data-parent="#accordion" data-toggle="collapse" href="#collapse${subject}"> $title</a>
			</div>
			<div id="collapse$subject" class="panel-collapse collapse #if($foreach.first) in #end">
				<div class="panel-body">
					<div id="${subject}-graph" class="scoreGraph" style="min-width: 60%"></div>
				</div>
			</div>
		</div>
	#end
</div>

<div class="well well-sm">
	Outliers computed using <a href="https://en.wikipedia.org/wiki/Chauvenet's_criterion" target="_blank">Chauvenet's Criterion for Outliers</a>
	with assumptions of Gaussian normality for sample populations of over 5 scores. Normal distribution curves idealized using the normal
	probability density function with the relevant group of scores' mean and standard deviation (artificial vertical scaling applied).
</div>

#set($minGrade = 1000)
#foreach($test in $tests)
	#if($summaryStats[$test]) <div id="$test" class="hide">$summaryStats[$test]</div> #end
	#if($test.getGrade() < $minGrade)
		#set($minGrade = $test.getGrade())
	#end
#end

<script type="text/javascript">
	$(document).ready(function () {
		#foreach($subject in $subjects)
			#set($title = $subject.getName().concat(" Scores"))

        	#set($outlierList = [])
        	#foreach($test in $tests)
        		#if($test.getSubject() == $subject)
	        		#foreach($outlier in $outliers[$test])
	        			#set($marker = $test.getGrade() - $minGrade)
	        			#set($outlierString = "[" + $marker + "," + $outlier + "]")
	        			#set($dummy = $outlierList.add($outlierString))
	        		#end
        		#end
        	#end
        	
			$('#${subject}-graph').highcharts({
			    chart: {
			        type: 'boxplot',
		            inverted: true,
		            width: $('.collapse.in').width() * .95
			    },
			    title: {
			        text: '$title'
			    },
			    legend: {
			        enabled: false
			    },
			    xAxis: {
			    	#if($level == "middle")
			        	categories: ['6', '7', '8'],
			        #else
			        	categories: ['9', '10', '11', '12'],
			        #end
			        title: {
			            text: 'Grade'
			        }
			    },
			    yAxis: {
			        title: {
			            text: 'Score'
			        }
			    },
				plotOptions: {
					boxplot: {
						colorByPoint: true
					}
				},
			    series: [{
			        name: 'Score',
			        color: Highcharts.getOptions().colors[0],
			        data: [
						#if($level == "middle")
				        	#foreach($i in [6..8])
								#set($testSummaryStats = $summaryStats[$Test.fromString("$i$subject")])
								[$testSummaryStats.get("min"), $testSummaryStats.get("q1"), $testSummaryStats.get("q2"), $testSummaryStats.get("q3"), $testSummaryStats.get("max")]#if(!$foreach.last),#end
							#end
			           	#else
			            	#foreach($i in [9..12])
								#set($testSummaryStats = $summaryStats[$Test.fromString("$i$subject")])
								[$testSummaryStats.get("min"), $testSummaryStats.get("q1"), $testSummaryStats.get("q2"), $testSummaryStats.get("q3"), $testSummaryStats.get("max")]#if(!$foreach.last),#end
							#end
			            #end
			        ],
			        tooltip: {
			            headerFormat: '<em>Grade {point.key}</em><br/>'
			        }
			    },{
			        name: 'Outlier',
			        color: Highcharts.getOptions().colors[0],
			        type: 'scatter',
			        data: [
			            #foreach($outlier in $outlierList)
			            	$outlier#if(!$foreach.last),#end
			            #end
			        ],
			        marker: {
			            fillColor: 'white',
			            lineWidth: 1,
			            lineColor: Highcharts.getOptions().colors[0]
			        },
			        tooltip: {
			            pointFormat: 'Score: {point.y}'
			        }
			    }]
			}, function(chart) {
				#if($level == "middle")
		        	#foreach($i in [6..8])
						#set($testSummaryStats = $summaryStats[$Test.fromString("$i$subject")])
					
						var mean = $testSummaryStats.get("mean"), sd = $testSummaryStats.get("sd");
						var multiplierX = chart.plotWidth / (chart.yAxis[0].max - chart.yAxis[0].min);
						var multiplierY = (chart.plotHeight / pdf(mean, mean, sd) * .9) * ((3 - $foreach.index) / 3);
						
						var points = ['M', chart.plotLeft, (chart.plotTop + chart.plotHeight) - (pdf(chart.yAxis[0].min, mean, sd) * multiplierY)];
						for(var i = chart.yAxis[0].min; (i - chart.yAxis[0].min) * multiplierX <= chart.plotWidth; i+=1) {
							points.push('L');
							points.push((i - chart.yAxis[0].min) * multiplierX + chart.plotLeft);
							points.push((chart.plotTop + chart.plotHeight) - (pdf(i, mean, sd) * multiplierY));
						}
						
				        chart.renderer.path(points).attr({
			                'stroke-width': 1,
			                stroke: Highcharts.getOptions().colors[$foreach.index],
			                zIndex: 3
			            }).add();
					#end
					
					function pdf(x, mean, sd) {
			    		var term1 = Math.pow(sd * Math.sqrt(2 * Math.PI), -1);
			    		var term2 = Math.pow(Math.E, -(Math.pow(x - mean, 2) / (2 * sd * sd)));
			    		return term1 * term2;
			    	}
	           	#else
	            	#foreach($i in [9..12])
						#set($testSummaryStats = $summaryStats[$Test.fromString("$i$subject")])
					
						var mean = $testSummaryStats.get("mean"), sd = $testSummaryStats.get("sd");
						var multiplierX = chart.plotWidth / (chart.yAxis[0].max - chart.yAxis[0].min);
						var multiplierY = (chart.plotHeight / pdf(mean, mean, sd) * .9) * ((4 - $foreach.index) / 4);
						
						var points = ['M', chart.plotLeft, (chart.plotTop + chart.plotHeight) - (pdf(chart.yAxis[0].min, mean, sd) * multiplierY)];
						for(var i = chart.yAxis[0].min; (i - chart.yAxis[0].min) * multiplierX <= chart.plotWidth; i+=1) {
							points.push('L');
							points.push((i - chart.yAxis[0].min) * multiplierX + chart.plotLeft);
							points.push((chart.plotTop + chart.plotHeight) - (pdf(i, mean, sd) * multiplierY));
						}
						
				        chart.renderer.path(points).attr({
			                'stroke-width': 1,
			                stroke: Highcharts.getOptions().colors[$foreach.index],
			                zIndex: 3
			            }).add();
					#end
	            #end
	            
				
		    });
		#end
	});
	
	$(window).resize(function() {
		$('.scoreGraph').setSize($('.collapse.in').width() * .95, 500);       
	});
</script>